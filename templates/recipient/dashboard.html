{% extends 'base.html' %}
{% load static %}

{% block title %}Recipient Dashboard - FoodLoop{% endblock %}

{% block extra_css %}
<style>
    .dashboard-header {
        background: linear-gradient(135deg, #17a2b8, #138496);
        border-radius: 15px 15px 0 0;
        color: white;
    }
    .stat-card {
        border: none;
        border-radius: 15px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-left: 4px solid transparent;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .nutrition-badge {
        background: linear-gradient(135deg, #00b894, #00a085);
        color: white;
        border: none;
    }
    .dietary-badge {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        border: none;
    }
    .match-badge {
        background: linear-gradient(135deg, #74b9ff, #0984e3);
        color: white;
        border: none;
    }
    .ai-recommendation-card {
        border: 2px solid #e3f2fd;
        border-radius: 12px;
        transition: all 0.3s ease;
        background: white;
    }
    .ai-recommendation-card:hover {
        border-color: #2196f3;
        box-shadow: 0 8px 25px rgba(33, 150, 243, 0.15);
        transform: translateY(-3px);
    }
    .match-score {
        font-size: 0.9em;
        font-weight: 600;
    }
    .nutrition-score-bar {
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
    }
    .nutrition-score-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b, #ffa726, #66bb6a);
        transition: width 0.5s ease;
    }
    .insight-card {
        background: linear-gradient(135deg, #fff3e0, #ffecb3);
        border: none;
        border-radius: 12px;
    }
    .quick-action-btn {
        border-radius: 25px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .dietary-preference-pill {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
        border-radius: 20px;
        padding: 5px 12px;
        font-size: 0.8em;
        margin: 2px;
    }
    .food-card {
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        height: 100%;
    }
    .food-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .food-image {
        height: 180px;
        object-fit: cover;
        width: 100%;
    }
    .claim-btn {
        border-radius: 20px;
        padding: 8px 20px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="dashboard-header text-white py-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h1 class="card-title mb-2">
                                    <i class="fas fa-tachometer-alt me-2"></i>Recipient Dashboard
                                </h1>
                                <p class="lead mb-0">Find nutritious food donations that match your preferences</p>
                                
                                <!-- Dietary Preferences Display -->
                                {% if dietary_badges %}
                                <div class="mt-3">
                                    <small class="text-white-50">Your Dietary Preferences:</small>
                                    <div class="mt-1">
                                        {% for restriction in dietary_badges %}
                                            <span class="badge dietary-badge me-1 mb-1">{{ restriction }}</span>
                                        {% endfor %}
                                        {% if user_profile.nutrition_goals != 'balanced' %}
                                            <span class="badge nutrition-badge me-1 mb-1">{{ user_profile.get_nutrition_goals_display }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 text-md-end">
                                <div class="btn-group">
                                    <a href="{% url 'ai_recommendations' %}" class="btn btn-light btn-lg">
                                        <i class="fas fa-robot me-2"></i>AI Recommendations
                                    </a>
                                    <a href="{% url 'nutrition_search' %}" class="btn btn-outline-light btn-lg ms-2">
                                        <i class="fas fa-search me-2"></i>Advanced Search
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nutrition Insights -->
    {% if nutrition_insights %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card insight-card shadow-sm border-0">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-1 text-center">
                            <i class="fas fa-lightbulb fa-2x text-warning"></i>
                        </div>
                        <div class="col-md-11">
                            <h5 class="card-title text-dark mb-2">
                                <i class="fas fa-chart-line me-2"></i>Nutrition Insights
                            </h5>
                            <div class="row">
                                {% for insight in nutrition_insights %}
                                <div class="col-md-6">
                                    <div class="d-flex align-items-start mb-2">
                                        <i class="fas fa-check-circle text-success mt-1 me-2"></i>
                                        <span class="text-dark">{{ insight }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Statistics Cards -->
    <div class="row mb-5">
        <div class="col-md-3 mb-3">
            <div class="card stat-card text-center p-4 bg-primary bg-opacity-10 border-left-primary">
                <i class="fas fa-hands-helping fa-2x text-primary mb-3"></i>
                <h2 class="fw-bold text-dark">{{ stats.total_claims }}</h2>
                <p class="text-muted mb-0">Total Claims</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card text-center p-4 bg-success bg-opacity-10 border-left-success">
                <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                <h2 class="fw-bold text-dark">{{ stats.completed_claims }}</h2>
                <p class="text-muted mb-0">Completed</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card text-center p-4 bg-warning bg-opacity-10 border-left-warning">
                <i class="fas fa-clock fa-2x text-warning mb-3"></i>
                <h2 class="fw-bold text-dark">{{ stats.active_claims }}</h2>
                <p class="text-muted mb-0">Active Claims</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card text-center p-4 bg-info bg-opacity-10 border-left-info">
                <i class="fas fa-fire fa-2x text-info mb-3"></i>
                <h2 class="fw-bold text-dark">{{ stats.total_calories }}</h2>
                <p class="text-muted mb-0">Calories Received</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- AI Recommendations Section -->
        <div class="col-lg-8">
            <!-- AI-Powered Recommendations -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-robot me-2 text-primary"></i>AI-Powered Recommendations
                        <small class="text-muted">(Personalized for you)</small>
                    </h4>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshRecommendations()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
                <div class="card-body">
                    {% if ai_recommendations %}
                    <div class="row" id="recommendationsContainer">
                        {% for donation in ai_recommendations %}
                        <div class="col-md-6 mb-4">
                            <div class="card ai-recommendation-card h-100">
                                {% if donation.image %}
                                <img src="{{ donation.image.url }}" class="food-image" alt="{{ donation.food_type }}">
                                {% else %}
                                <div class="food-image bg-light d-flex align-items-center justify-content-center">
                                    <i class="fas fa-utensils fa-3x text-muted"></i>
                                </div>
                                {% endif %}
                                
                                <div class="card-body">
                                    <!-- Match Score -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="match-badge match-score">
                                            <i class="fas fa-bullseye me-1"></i>{{ donation.match_score }}% Match
                                        </span>
                                        <span class="badge nutrition-badge">
                                            {{ donation.nutrition_score }}/100
                                        </span>
                                    </div>

                                    <!-- Nutrition Score Bar -->
                                    <div class="nutrition-score-bar mb-3">
                                        <div class="nutrition-score-fill" style="width: {{ donation.nutrition_score }}%"></div>
                                    </div>

                                    <h6 class="card-title">{{ donation.food_type|title }}</h6>
                                    <p class="card-text text-muted small">{{ donation.description|truncatewords:15 }}</p>
                                    
                                    <!-- Dietary Tags -->
                                    {% if donation.dietary_tags %}
                                    <div class="mb-2">
                                        {% for tag in donation.dietary_tags %}
                                            <span class="dietary-preference-pill">{{ tag }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}

                                    <!-- Nutrition Info -->
                                    <div class="d-flex justify-content-between text-muted small mb-3">
                                        <span>
                                            <i class="fas fa-fire me-1"></i>
                                            {{ donation.calorie_info }}
                                        </span>
                                        <span>
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            {{ donation.location|truncatewords:2 }}
                                        </span>
                                    </div>

                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            {{ donation.created_at|timesince }} ago
                                        </small>
                                        <form method="post" action="{% url 'claim_donation' donation.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-success btn-sm claim-btn">
                                                <i class="fas fa-hand-holding-heart me-1"></i>Claim
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No personalized recommendations available</h5>
                        <p class="text-muted">Complete your dietary preferences to get better recommendations</p>
                        <a href="{% url 'profile' %}" class="btn btn-primary">
                            <i class="fas fa-user-edit me-1"></i>Update Profile
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Available Donations -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-transparent border-0 py-3">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-utensils me-2 text-success"></i>All Available Donations
                    </h4>
                </div>
                <div class="card-body">
                    {% if available_donations %}
                    <div class="row">
                        {% for donation in available_donations %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card food-card h-100">
                                {% if donation.image %}
                                <img src="{{ donation.image.url }}" class="food-image" alt="{{ donation.food_type }}">
                                {% else %}
                                <div class="food-image bg-light d-flex align-items-center justify-content-center">
                                    <i class="fas fa-utensils fa-3x text-muted"></i>
                                </div>
                                {% endif %}
                                
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0">{{ donation.food_type|title }}</h6>
                                        <span class="badge {% if donation.match_score > 80 %}nutrition-badge{% else %}bg-secondary{% endif %}">
                                            {{ donation.nutrition_badge }}
                                        </span>
                                    </div>
                                    
                                    <p class="card-text text-muted small">{{ donation.description|truncatewords:12 }}</p>
                                    
                                    <!-- Match Indicator -->
                                    {% if donation.match_score %}
                                    <div class="mb-2">
                                        <small class="text-muted">Match: {{ donation.match_score }}%</small>
                                        <div class="progress" style="height: 4px;">
                                            <div class="progress-bar {% if donation.match_score > 80 %}bg-success{% elif donation.match_score > 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 style="width: {{ donation.match_score }}%"></div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <div class="d-flex justify-content-between text-muted small mb-3">
                                        <span>
                                            <i class="fas fa-fire me-1"></i>
                                            {{ donation.calorie_info }}
                                        </span>
                                        <span>
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            {{ donation.location|truncatewords:1 }}
                                        </span>
                                    </div>

                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            {{ donation.created_at|timesince }} ago
                                        </small>
                                        <div>
                                            <a href="{% url 'donation_detail' donation.id %}" class="btn btn-outline-primary btn-sm me-1">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <form method="post" action="{% url 'claim_donation' donation.id %}" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-success btn-sm">
                                                    <i class="fas fa-hand-holding-heart"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No donations available at the moment</h5>
                        <p class="text-muted">Check back later for new donations</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2 text-warning"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'nutrition_search' %}" class="btn btn-outline-primary quick-action-btn">
                            <i class="fas fa-search me-2"></i>Nutrition Search
                        </a>
                        <a href="{% url 'map_view' %}" class="btn btn-outline-success quick-action-btn">
                            <i class="fas fa-map me-2"></i>View Map
                        </a>
                        <a href="{% url 'profile' %}" class="btn btn-outline-info quick-action-btn">
                            <i class="fas fa-utensils me-2"></i>Dietary Preferences
                        </a>
                        <a href="{% url 'nutrition_analytics' %}" class="btn btn-outline-warning quick-action-btn">
                            <i class="fas fa-chart-bar me-2"></i>My Analytics
                        </a>
                    </div>
                </div>
            </div>

            <!-- My Active Claims -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list-alt me-2 text-info"></i>My Active Claims
                    </h5>
                </div>
                <div class="card-body">
                    {% if my_donations %}
                    <div class="list-group list-group-flush">
                        {% for donation in my_donations %}
                        {% if donation.status == 'claimed' %}
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ donation.food_type|title }}</h6>
                                    <small class="text-muted">From {{ donation.donor.username }}</small>
                                    <br>
                                    <small class="text-warning">
                                        <i class="fas fa-clock me-1"></i>
                                        Pickup by {{ donation.pickup_deadline|date:"M j, g:i A" }}
                                    </small>
                                </div>
                                <span class="badge bg-warning">Claimed</span>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-shopping-cart fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No active claims</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Nutrition Stats -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2 text-success"></i>Nutrition Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="display-6 fw-bold text-success">{{ stats.avg_nutrition_score }}</div>
                        <small class="text-muted">Average Nutrition Score</small>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block mb-1">Total Calories Received</small>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: {% widthratio stats.total_calories 5000 100 %}%"></div>
                        </div>
                        <small class="text-muted">{{ stats.total_calories }} calories</small>
                    </div>

                    <div class="mb-3">
                        <small class="text-muted d-block mb-1">Completion Rate</small>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-info" style="width: {% widthratio stats.completed_claims stats.total_claims 100 %}%"></div>
                        </div>
                        <small class="text-muted">{{ stats.completed_claims }} of {{ stats.total_claims }} completed</small>
                    </div>

                    <div class="text-center mt-4">
                        <a href="{% url 'nutrition_analytics' %}" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-chart-line me-1"></i>View Detailed Analytics
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function refreshRecommendations() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
    button.disabled = true;

    fetch('{% url "refresh_recommendations" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateRecommendationsUI(data.recommendations);
            showToast('Recommendations updated successfully!', 'success');
        } else {
            showToast('Failed to refresh recommendations', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error refreshing recommendations', 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function updateRecommendationsUI(recommendations) {
    const container = document.getElementById('recommendationsContainer');
    
    if (recommendations.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No new recommendations found</h5>
                <p class="text-muted">Try updating your dietary preferences</p>
            </div>
        `;
        return;
    }

    let html = '';
    recommendations.forEach(donation => {
        html += `
            <div class="col-md-6 mb-4">
                <div class="card ai-recommendation-card h-100">
                    <img src="${donation.image_url}" class="food-image" alt="${donation.food_type}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="match-badge match-score">
                                <i class="fas fa-bullseye me-1"></i>${donation.match_score}% Match
                            </span>
                            <span class="badge nutrition-badge">
                                ${donation.nutrition_score}/100
                            </span>
                        </div>
                        <div class="nutrition-score-bar mb-3">
                            <div class="nutrition-score-fill" style="width: ${donation.nutrition_score}%"></div>
                        </div>
                        <h6 class="card-title">${donation.food_type}</h6>
                        <p class="card-text text-muted small">${donation.description}</p>
                        <div class="d-flex justify-content-between text-muted small mb-3">
                            <span><i class="fas fa-fire me-1"></i>~${donation.calories} cal</span>
                            <span><i class="fas fa-map-marker-alt me-1"></i>Nearby</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Just now</small>
                            <a href="${donation.detail_url}" class="btn btn-success btn-sm claim-btn">
                                <i class="fas fa-hand-holding-heart me-1"></i>Claim
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function showToast(message, type) {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}