{% extends 'base/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Impact Analytics - FoodLoop{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto pt-6 pb-12">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 mb-8">
        <div>
            <h1 class="text-3xl md:text-4xl font-display font-extrabold text-slate-900 leading-tight">
                {% if is_donor %}Impact Report üåç{% else %}Nutrition Log ü•ó{% endif %}
            </h1>
            <p class="text-slate-500 mt-2 text-lg">
                Overview of activity for the last <strong>{{ date_range|upper }}</strong>.
            </p>
        </div>
        
        <div class="bg-white p-1 rounded-xl border border-slate-200 inline-flex shadow-sm">
            {% for range_opt in date_ranges %}
            <a href="?range={{ range_opt }}" 
               class="px-4 py-2 rounded-lg text-sm font-bold transition-all {% if date_range == range_opt %}bg-slate-900 text-white shadow-sm{% else %}text-slate-500 hover:bg-slate-50{% endif %}">
                {{ range_opt|upper }}
            </a>
            {% endfor %}
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="card bg-gradient-to-br from-brand-500 to-brand-700 text-white border-none shadow-brand-500/20 shadow-xl">
            <div class="flex items-center gap-3 mb-4 opacity-90">
                <i class="fas {% if is_donor %}fa-hand-holding-heart{% else %}fa-fire{% endif %}"></i>
                <span class="text-xs font-bold uppercase tracking-wider">Total Calories</span>
            </div>
            <div class="text-4xl font-extrabold mb-2">
                {{ analytics.nutrition_impact.total_calories|intcomma }}
            </div>
            <div class="text-sm opacity-80 font-medium">
                ~{{ analytics.nutrition_impact.total_calories|default:0|divisibleby:600 }} meals equivalent
            </div>
        </div>

        <div class="card">
            <div class="flex items-center gap-3 mb-4 text-blue-600">
                <i class="fas {% if is_donor %}fa-check-circle{% else %}fa-shopping-basket{% endif %}"></i>
                <span class="text-xs font-bold uppercase tracking-wider">
                    {% if is_donor %}Success Rate{% else %}Items Rescued{% endif %}
                </span>
            </div>
            <div class="text-4xl font-extrabold text-slate-900 mb-2">
                {% if is_donor %}
                    {{ analytics.donation_stats.completion_rate }}%
                {% else %}
                    {{ analytics.donation_stats.completed }}
                {% endif %}
            </div>
            <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden mt-4">
                <div class="h-full bg-blue-600 rounded-full" style="width: {% if is_donor %}{{ analytics.donation_stats.completion_rate }}{% else %}100{% endif %}%;"></div>
            </div>
        </div>

        <div class="card">
            <div class="flex items-center gap-3 mb-4 text-yellow-500">
                <i class="fas {% if is_donor %}fa-star{% else %}fa-leaf{% endif %}"></i>
                <span class="text-xs font-bold uppercase tracking-wider">
                    {% if is_donor %}Rating{% else %}Nutri-Score{% endif %}
                </span>
            </div>
            <div class="text-4xl font-extrabold text-slate-900 mb-2">
                {% if is_donor %}
                    {{ analytics.reputation.avg_rating }}
                {% else %}
                    {{ analytics.nutrition_impact.avg_nutrition_score|floatformat:0 }}
                {% endif %}
            </div>
            <p class="text-sm text-slate-400 font-medium">
                {% if is_donor %}Based on {{ analytics.reputation.total_ratings }} reviews{% else %}Average quality score{% endif %}
            </p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="card p-6 lg:col-span-2">
            <h3 class="text-lg font-bold text-slate-900 mb-6">Activity Trends</h3>
            <div class="relative w-full min-h-[300px]">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <div class="card p-6">
            <h3 class="text-lg font-bold text-slate-900 mb-6">Top Categories</h3>
            <div class="relative w-full min-h-[250px] flex items-center justify-center">
                <canvas id="categoryChart"></canvas>
                {% if not trends.category_breakdown %}
                    <div class="absolute inset-0 flex items-center justify-center bg-white/80 text-slate-400 font-medium text-sm">
                        No data yet
                    </div>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<style>
    /* Chart responsiveness wrapper override */
    canvas { width: 100% !important; height: 100% !important; }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. Prepare Data from Django Context
        const dailyLabels = [{% for day in trends.daily_trends %}"{{ day.day|date:'M d' }}",{% endfor %}];
        const dailyCounts = [{% for day in trends.daily_trends %}{{ day.count }},{% endfor %}];
        
        const catLabels = [{% for cat in trends.category_breakdown %}"{{ cat.food_category|title }}",{% endfor %}];
        const catCounts = [{% for cat in trends.category_breakdown %}{{ cat.count }},{% endfor %}];

        // 2. Trend Chart (Line)
        const ctxTrend = document.getElementById('trendChart').getContext('2d');
        new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: dailyLabels,
                datasets: [{
                    label: 'Items',
                    data: dailyCounts,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: '#10b981',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [4, 4], color: '#f1f5f9' } },
                    x: { grid: { display: false } }
                }
            }
        });

        // 3. Category Chart (Doughnut)
        if (catLabels.length > 0) {
            const ctxCat = document.getElementById('categoryChart').getContext('2d');
            new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: catLabels,
                    datasets: [{
                        data: catCounts,
                        backgroundColor: [
                            '#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8, padding: 20 } }
                    },
                    cutout: '75%'
                }
            });
        }
    });
</script>
{% endblock %}